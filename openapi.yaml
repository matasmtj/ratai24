openapi: 3.1.0
info:
  title: Car Lease, Sale & Parts API
  version: 2.0.0
  description: >
    REST API for City → Car → Contract with JWT (roles: guest/user/admin).
    Cars have rich specs including VIN and number plate; Contracts track mileage/fuel and support flexible updates plus completion workflow.
    Version 2.0.0 adds:
    - Cars for Sale feature (availableForLease, availableForSale, salePrice fields)
    - Parts marketplace (car parts with mandatory and optional fields)
    - Enhanced car management for dual lease/sale availability
    - Parts with images, filtering, and inventory management
servers:
  # Use relative URL so Swagger works both locally and in production (Render, etc.)
  - url: /
tags:
  - name: Auth
  - name: Users
  - name: Cities
  - name: Cars
  - name: Cars for Sale
  - name: Parts
  - name: Contacts
  - name: Contracts
  - name: Pricing
    description: Dynamic pricing calculations (public endpoints)
  - name: Admin - Pricing
    description: Pricing management and analytics (admin only)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        error: { type: string }
        details: { type: object }

    # ---------- Enums ----------
    FuelType:
      type: string
      enum: [PETROL, DIESEL, ELECTRIC, HYBRID_HEV, HYBRID_PHEV]
    Gearbox:
      type: string
      enum: [MANUAL, AUTOMATIC]
    BodyType:
      type: string
      enum: [SEDAN, HATCHBACK, SUV, WAGON, COUPE, CONVERTIBLE, VAN, PICKUP]
    CarState:
      type: string
      enum: [AVAILABLE, LEASED, MAINTENANCE]
    ContractState:
      type: string
      enum: [DRAFT, ACTIVE, COMPLETED, CANCELLED]
    PartCondition:
      type: string
      enum: [NEW, USED, REFURBISHED]

    # ---------- City ----------
    City:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: Vilnius }
        country: { type: string, example: LT }
    CityCreate:
      type: object
      required: [name, country]
      properties:
        name: { type: string }
        country: { type: string }

    # ---------- Car ----------
    Car:
      type: object
      properties:
        id: { type: integer }
        vin:
          type: string
          example: "5YJ3E1EA7KF317000"
          description: "Unique 17-character VIN (A-H J-N P R-Z, 0-9; no I/O/Q)"
        numberPlate:
          type: string
          example: "EV-777"
          description: "License plate"
        make: { type: string }
        model: { type: string }
        year: { type: integer }
        pricePerDay: { type: number, format: float }
        availableForLease: { type: boolean, default: true, description: "Whether the car is available for lease" }
        availableForSale: { type: boolean, default: false, description: "Whether the car is available for sale" }
        salePrice: { type: number, format: float, nullable: true, description: "Sale price if car is for sale" }
        saleDescription: { type: string, nullable: true, description: "Description/comment for sale listing" }
        useDynamicPricing: { type: boolean, default: true, description: "Whether dynamic pricing is enabled for this car" }
        basePricePerDay: { type: number, format: float, nullable: true, description: "Calculated base price per day" }
        minPricePerDay: { type: number, format: float, nullable: true, description: "Minimum price per day (floor)" }
        maxPricePerDay: { type: number, format: float, nullable: true, description: "Maximum price per day (ceiling)" }
        cityId: { type: integer }
        seatCount: { type: integer, example: 5 }
        fuelType: { $ref: '#/components/schemas/FuelType' }
        powerKW: { type: integer, example: 208 }
        engineCapacityL:
          type: number
          format: float
          nullable: true
          example: null
          description: "null for ELECTRIC"
        bodyType: { $ref: '#/components/schemas/BodyType' }
        gearbox: { $ref: '#/components/schemas/Gearbox' }
        colour: { type: string, nullable: true, description: "Car color" }
        state: { $ref: '#/components/schemas/CarState' }
        odometerKm: { type: integer, example: 15000 }
        images:
          type: array
          items:
            $ref: '#/components/schemas/CarImage'

    CarCreate:
      type: object
      required:
        - vin
        - numberPlate
        - make
        - model
        - year
        - pricePerDay
        - cityId
        - fuelType
        - powerKW
        - bodyType
        - gearbox
      properties:
        vin:
          type: string
          description: "17-char VIN (A-H J-N P R-Z, 0-9; no I/O/Q)"
          example: "5YJ3E1EA7KF317000"
        numberPlate:
          type: string
          description: "2–12 chars; letters/digits/space/hyphen"
          example: "EV-777"
        make: { type: string, example: "Tesla" }
        model: { type: string, example: "Model 3" }
        year: { type: integer, example: 2022 }
        pricePerDay: { type: number, format: float, example: 95 }
        availableForLease: { type: boolean, default: true }
        availableForSale: { type: boolean, default: false }
        salePrice: { type: number, format: float, nullable: true, example: 25000 }
        saleDescription: { type: string, nullable: true, example: "Well-maintained, single owner, full service history" }
        cityId: { type: integer, example: 1 }
        seatCount: { type: integer, default: 5, example: 5 }
        fuelType: { $ref: '#/components/schemas/FuelType' }
        powerKW: { type: integer, example: 208 }
        engineCapacityL:
          type: number
          format: float
          nullable: true
          example: null
          description: "null for ELECTRIC"
        bodyType: { $ref: '#/components/schemas/BodyType' }
        gearbox: { $ref: '#/components/schemas/Gearbox' }
        colour: { type: string, example: "Blue" }
        state: { $ref: '#/components/schemas/CarState' }
        odometerKm: { type: integer, default: 0, example: 15000 }

    # ---------- Car Image ----------
    CarImage:
      type: object
      properties:
        id: { type: integer, example: 1 }
        carId: { type: integer, example: 1 }
        filename: { type: string, example: "1733154123456-a1b2c3d4.jpg" }
        url: { type: string, example: "/uploads/1733154123456-a1b2c3d4.jpg" }
        isMain: { type: boolean, example: true }
        order: { type: integer, example: 0, description: "Display order of the image" }
        createdAt: { type: string, format: date-time }

    # ---------- Part ----------
    Part:
      type: object
      properties:
        id: { type: integer }
        make: { type: string, example: "BMW", description: "Car manufacturer" }
        model: { type: string, example: "320i", description: "Car model" }
        year: { type: integer, example: 2018 }
        oem: { type: string, example: "51117222222", description: "OEM part number" }
        partName: { type: string, example: "Front Bumper", description: "Name of the part" }
        engineCapacityL: { type: number, format: float, nullable: true, example: 2.0 }
        powerKW: { type: integer, nullable: true, example: 135 }
        fuelType: { $ref: '#/components/schemas/FuelType', nullable: true }
        colour: { type: string, nullable: true, example: "Black" }
        gearbox: { $ref: '#/components/schemas/Gearbox', nullable: true }
        bodyType: { $ref: '#/components/schemas/BodyType', nullable: true }
        description: { type: string, nullable: true, description: "Detailed description of the part" }
        condition: { $ref: '#/components/schemas/PartCondition' }
        price: { type: number, format: float, example: 450.00 }
        stockQuantity: { type: integer, example: 1, default: 1 }
        images:
          type: array
          items:
            $ref: '#/components/schemas/PartImage'
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    PartCreate:
      type: object
      required:
        - make
        - model
        - year
        - oem
        - partName
        - price
      properties:
        make: { type: string, example: "BMW" }
        model: { type: string, example: "320i" }
        year: { type: integer, example: 2018 }
        oem: { type: string, example: "51117222222" }
        partName: { type: string, example: "Front Bumper" }
        engineCapacityL: { type: number, format: float, nullable: true }
        powerKW: { type: integer, nullable: true }
        fuelType: { $ref: '#/components/schemas/FuelType', nullable: true }
        colour: { type: string, nullable: true }
        gearbox: { $ref: '#/components/schemas/Gearbox', nullable: true }
        bodyType: { $ref: '#/components/schemas/BodyType', nullable: true }
        description: { type: string, nullable: true }
        condition: { $ref: '#/components/schemas/PartCondition', default: USED }
        price: { type: number, format: float, example: 450.00 }
        stockQuantity: { type: integer, default: 1 }

    # ---------- Part Image ----------
    PartImage:
      type: object
      properties:
        id: { type: integer, example: 1 }
        partId: { type: integer, example: 1 }
        filename: { type: string, example: "1733154123456-part-a1b2c3.jpg" }
        url: { type: string, example: "/uploads/parts/1733154123456-part-a1b2c3.jpg" }
        isMain: { type: boolean, example: true }
        order: { type: integer, example: 0, description: "Display order of the image" }
        createdAt: { type: string, format: date-time }

    # ---------- User ----------
    User:
      type: object
      properties:
        id: { type: integer, example: 1 }
        email: { type: string, format: email, example: "user@example.com" }
        firstName: { type: string, nullable: true, example: "John" }
        lastName: { type: string, nullable: true, example: "Doe" }
        phoneNumber: { type: string, nullable: true, example: "+37060012345" }
        role: { type: string, enum: [GUEST, USER, ADMIN], example: "USER" }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    UserUpdate:
      type: object
      properties:
        email: { type: string, format: email, example: "newemail@example.com" }
        firstName: { type: string, nullable: true, example: "John" }
        lastName: { type: string, nullable: true, example: "Doe" }
        phoneNumber: { type: string, nullable: true, example: "+37060012345" }
        password: { type: string, format: password, minLength: 8, example: "newpassword123" }
      additionalProperties: false
    UserCreate:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email, example: "newuser@example.com" }
        password: { type: string, format: password, minLength: 8, example: "password123" }
        firstName: { type: string, example: "John" }
        lastName: { type: string, example: "Doe" }
        phoneNumber: { type: string, example: "+37060012345" }
        role: { type: string, enum: [GUEST, USER, ADMIN], example: "USER" }
    UserAdminUpdate:
      type: object
      properties:
        email: { type: string, format: email, example: "newemail@example.com" }
        firstName: { type: string, nullable: true, example: "John" }
        lastName: { type: string, nullable: true, example: "Doe" }
        phoneNumber: { type: string, nullable: true, example: "+37060012345" }
        password: { type: string, format: password, minLength: 8, example: "newpassword123" }
        role: { type: string, enum: [GUEST, USER, ADMIN], example: "USER" }
      additionalProperties: false

    # ---------- Contract ----------
    Contract:
      type: object
      properties:
        id: { type: integer }
        userId: { type: integer }
        carId: { type: integer }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time }
        totalPrice: { type: number, format: float }
        state: { $ref: '#/components/schemas/ContractState' }
        mileageStartKm: { type: integer }
        mileageEndKm: { type: integer, nullable: true }
        fuelLevelStartPct: { type: integer }
        fuelLevelEndPct: { type: integer, nullable: true }
        extraFees: { type: number, format: float, default: 0 }
        notes: { type: string, nullable: true }
    ContractCreate:
      type: object
      required: [carId, startDate, endDate, mileageStartKm, fuelLevelStartPct]
      properties:
        carId: { type: integer }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time }
        mileageStartKm: { type: integer }
        fuelLevelStartPct: { type: integer }
        notes: { type: string }
    ContractUpdate:
      type: object
      properties:
        carId: { type: integer }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time }
        state: { $ref: '#/components/schemas/ContractState' }
        mileageEndKm: { type: integer }
        fuelLevelEndPct: { type: integer }
        notes: { type: string }
      additionalProperties: false
    ContractComplete:
      type: object
      required: [mileageEndKm, fuelLevelEndPct]
      properties:
        mileageEndKm: { type: integer, example: 60350 }
        fuelLevelEndPct: { type: integer, minimum: 0, maximum: 100, example: 50 }
        damageFee: { type: number, format: float, minimum: 0, example: 25 }
        notes: { type: string, example: "Minor scratch on rear bumper" }
      additionalProperties: false

    # ---------- Contact ----------
    Contact:
      type: object
      properties:
        id: { type: integer, example: 1 }
        email: { type: string, format: email, example: "contact@carlease.com" }
        phone: { type: string, example: "+370 612 34567" }
        operationAreas: 
          type: string
          example: "Vilnius, Kaunas, Klaipėda"
          description: "Comma-separated list of city names (for backward compatibility)"
        operationAreasDetails:
          type: array
          items:
            $ref: '#/components/schemas/ContactOperationArea'
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    ContactOperationArea:
      type: object
      properties:
        id: { type: integer, example: 1 }
        cityId: { type: integer, example: 1 }
        cityName: { type: string, example: "Vilnius" }
        country: { type: string, example: "LT" }
        address: 
          type: string
          example: "Konstitucijos pr. 20"
          description: "Optional specific address in this city"

    ContactCreate:
      type: object
      required: [email, phone, operationAreas]
      properties:
        email: 
          type: string
          format: email
          example: "contact@carlease.com"
        phone: 
          type: string
          example: "+370 612 34567"
          description: "Minimum 7 characters, digits, spaces, +, -, (), allowed"
        operationAreas:
          type: array
          minItems: 1
          items:
            type: object
            required: [cityId]
            properties:
              cityId: { type: integer, example: 1 }
              address: 
                type: string
                example: "Konstitucijos pr. 20"
                description: "Optional specific address"
      additionalProperties: false

    ContactUpdate:
      type: object
      properties:
        email: 
          type: string
          format: email
          example: "contact@carlease.com"
        phone: 
          type: string
          example: "+370 612 34567"
        operationAreas:
          type: array
          items:
            type: object
            required: [cityId]
            properties:
              cityId: { type: integer }
              address: { type: string }
      additionalProperties: false

paths:
  /health:
    get:
      tags: [Auth]
      summary: Health check
      responses:
        '200': { description: OK }

  # ---------- Auth ----------
  /auth/register:
    post:
      tags: [Auth]
      summary: Register a user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, example: newuser@example.com }
                password: { type: string, example: NewUser123! }
                role: { type: string, enum: [USER, ADMIN] }
      responses:
        '201': { description: Created }
        '400': { description: Bad request, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /auth/login:
    post:
      tags: [Auth]
      summary: Login and receive tokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, example: user@example.com }
                password: { type: string, example: User123! }
      responses:
        '200':
          description: Tokens
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken: { type: string }
                  refreshToken: { type: string }
                  refreshExpiresAt: { type: string, format: date-time }
                  role: { type: string, example: USER }
        '401': { description: Invalid credentials, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Rotate refresh token and get new access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        '200': { description: New tokens }
        '401': { description: Invalid refresh token }

  /auth/logout:
    post:
      tags: [Auth]
      summary: Revoke a refresh token (logout)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        '204': { description: No Content }

  # ---------- Users ----------
  /users/me:
    get:
      tags: [Users]
      summary: Get current user profile
      description: Returns the authenticated user's profile information
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags: [Users]
      summary: Update current user profile
      description: >
        Update email, firstName, lastName, phoneNumber, and/or password.
        Email must be unique and valid format.
        Password must be at least 8 characters.
        Changing password will revoke all refresh tokens.
        Role cannot be changed via this endpoint.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: Updated user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error (invalid email format or password too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users:
    get:
      tags: [Users]
      summary: List all users (Admin only)
      description: >
        Get a list of all users with optional filtering.
        Requires ADMIN role.
      security: [{ bearerAuth: [] }]
      parameters:
        - name: role
          in: query
          schema:
            type: string
            enum: [GUEST, USER, ADMIN]
          description: Filter by user role
        - name: search
          in: query
          schema:
            type: string
          description: Search by email, firstName, or lastName
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires ADMIN role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags: [Users]
      summary: Create new user (Admin only)
      description: >
        Create a new user with specified role.
        Requires ADMIN role.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreate'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires ADMIN role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{id}:
    get:
      tags: [Users]
      summary: Get user by ID (Admin only)
      description: >
        Get detailed information about a specific user.
        Requires ADMIN role.
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Invalid user ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires ADMIN role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags: [Users]
      summary: Update user (Admin only)
      description: >
        Update any user's details including role.
        Admins can change user roles and all profile fields.
        Requires ADMIN role.
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserAdminUpdate'
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires ADMIN role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags: [Users]
      summary: Delete user (Admin only)
      description: >
        Delete a user from the system.
        Admin cannot delete their own account.
        Requires ADMIN role.
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: User ID
      responses:
        '204':
          description: User deleted
        '400':
          description: Cannot delete own account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - requires ADMIN role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ---------- Cities ----------
  /cities:
    get:
      tags: [Cities]
      summary: List cities
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { type: array, items: { $ref: '#/components/schemas/City' } }
    post:
      tags: [Cities]
      summary: Create city (ADMIN)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CityCreate' }
            example: { name: Klaipeda, country: LT }
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/City' } } } }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '409': { description: Conflict (city name already exists) }

  /cities/{id}:
    get:
      tags: [Cities]
      summary: Get city by ID
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/City' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    put:
      tags: [Cities]
      summary: Update city (ADMIN)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CityCreate' }
            example: { name: Klaipeda Updated, country: LT }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/City' } } } }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '409': { description: Conflict (city name already exists) }
    delete:
      tags: [Cities]
      summary: Delete city (ADMIN)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: Deleted city, content: { application/json: { schema: { $ref: '#/components/schemas/City' } } } }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }

  /cities/{id}/cars:
    get:
      tags: [Cities]
      summary: List cars in a city (hierarchical)
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: OK }
        '404': { description: City not found }

  # ---------- Cars ----------
  /cars:
    get:
      tags: [Cars]
      summary: List cars (optional filter by cityId)
      parameters:
        - in: query
          name: cityId
          schema: { type: integer }
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/Car' } } } } }
    post:
      tags: [Cars]
      summary: Create car (ADMIN)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CarCreate' }
            example:
              vin: "5YJ3E1EA7KF317000"
              numberPlate: "EV-777"
              make: Tesla
              model: Model 3
              year: 2022
              pricePerDay: 95
              cityId: 1
              seatCount: 5
              fuelType: ELECTRIC
              powerKW: 208
              engineCapacityL: null
              bodyType: SEDAN
              gearbox: AUTOMATIC
              state: AVAILABLE
              odometerKm: 15000
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/Car' } } } }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '409': { description: Conflict (VIN or numberPlate already exists) }

  /cars/{id}:
    get:
      tags: [Cars]
      summary: Get car by ID
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Car' } } } }
        '404': { description: Not found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    put:
      tags: [Cars]
      summary: Update car (ADMIN)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              # You can send full CarCreate shape; server also supports partial update.
              $ref: '#/components/schemas/CarCreate'
            example:
              vin: "JTDBR32E920123456"
              numberPlate: "ABC-123"
              make: Toyota
              model: Corolla
              year: 2021
              pricePerDay: 40
              cityId: 1
              seatCount: 5
              fuelType: PETROL
              powerKW: 97
              engineCapacityL: 1.6
              bodyType: SEDAN
              gearbox: MANUAL
              state: AVAILABLE
              odometerKm: 61000
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Car' } } } }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '409': { description: Conflict (VIN or numberPlate already exists) }
    delete:
      tags: [Cars]
      summary: Delete car (ADMIN)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: Deleted car, content: { application/json: { schema: { $ref: '#/components/schemas/Car' } } } }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }

  /cars/{id}/contracts:
    get:
      tags: [Cars]
      summary: List contracts for a specific car (hierarchical)
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: OK }
        '404': { description: Car not found }

  # ========== Cars for Sale ==========
  /cars/for-sale:
    get:
      tags: [Cars for Sale]
      summary: List cars available for sale
      description: >
        Returns all cars where availableForSale is true.
        Supports filtering by cityId, make, model, year, priceRange, etc.
        Does NOT include license plate (numberPlate) in the response.
      parameters:
        - in: query
          name: cityId
          schema: { type: integer }
          description: Filter by city
        - in: query
          name: make
          schema: { type: string }
          description: Filter by car make
        - in: query
          name: model
          schema: { type: string }
          description: Filter by car model
        - in: query
          name: minPrice
          schema: { type: number, format: float }
          description: Minimum sale price
        - in: query
          name: maxPrice
          schema: { type: number, format: float }
          description: Maximum sale price
        - in: query
          name: year
          schema: { type: integer }
          description: Filter by year
      responses:
        '200':
          description: List of cars for sale (without numberPlate)
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: integer }
                    vin: { type: string }
                    make: { type: string }
                    model: { type: string }
                    year: { type: integer }
                    salePrice: { type: number, format: float }
                    availableForLease: { type: boolean, description: "Indicates if also available for lease" }
                    cityId: { type: integer }
                    seatCount: { type: integer }
                    fuelType: { $ref: '#/components/schemas/FuelType' }
                    powerKW: { type: integer }
                    engineCapacityL: { type: number, format: float, nullable: true }
                    bodyType: { $ref: '#/components/schemas/BodyType' }
                    gearbox: { $ref: '#/components/schemas/Gearbox' }
                    colour: { type: string, nullable: true }
                    odometerKm: { type: integer }
                    images: { type: array, items: { $ref: '#/components/schemas/CarImage' } }

  /cars/for-sale/{id}:
    get:
      tags: [Cars for Sale]
      summary: Get car for sale details by ID
      description: >
        Returns detailed information about a car for sale.
        Does NOT include license plate (numberPlate).
        Includes a note about contacting the seller for more information.
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200':
          description: Car for sale details (without numberPlate)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: integer }
                  vin: { type: string }
                  make: { type: string }
                  model: { type: string }
                  year: { type: integer }
                  salePrice: { type: number, format: float }
                  availableForLease: { type: boolean }
                  cityId: { type: integer }
                  seatCount: { type: integer }
                  fuelType: { $ref: '#/components/schemas/FuelType' }
                  powerKW: { type: integer }
                  engineCapacityL: { type: number, format: float, nullable: true }
                  bodyType: { $ref: '#/components/schemas/BodyType' }
                  gearbox: { $ref: '#/components/schemas/Gearbox' }
                  colour: { type: string, nullable: true }
                  odometerKm: { type: integer }
                  images: { type: array, items: { $ref: '#/components/schemas/CarImage' } }
                  contactMessage: { type: string, example: "For more information, please contact us" }
        '404':
          description: Car not found or not available for sale
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ========== Parts ==========
  /parts:
    get:
      tags: [Parts]
      summary: List all car parts
      description: >
        Returns all car parts with optional filtering.
        Supports filtering by make, model, year, OEM, partName, condition, etc.
      parameters:
        - in: query
          name: make
          schema: { type: string }
          description: Filter by car make
        - in: query
          name: model
          schema: { type: string }
          description: Filter by car model
        - in: query
          name: year
          schema: { type: integer }
          description: Filter by year
        - in: query
          name: oem
          schema: { type: string }
          description: Filter by OEM part number
        - in: query
          name: partName
          schema: { type: string }
          description: Search by part name
        - in: query
          name: condition
          schema: { $ref: '#/components/schemas/PartCondition' }
          description: Filter by condition
        - in: query
          name: minPrice
          schema: { type: number, format: float }
          description: Minimum price
        - in: query
          name: maxPrice
          schema: { type: number, format: float }
          description: Maximum price
        - in: query
          name: inStock
          schema: { type: boolean }
          description: Show only parts in stock (stockQuantity > 0)
      responses:
        '200':
          description: List of parts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Part'
    post:
      tags: [Parts]
      summary: Create new part (ADMIN only)
      description: Add a new car part to the marketplace
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PartCreate'
            example:
              make: "BMW"
              model: "320i"
              year: 2018
              oem: "51117222222"
              partName: "Front Bumper"
              condition: "USED"
              price: 450.00
              stockQuantity: 1
              colour: "Black"
              description: "Good condition front bumper, minor scratches"
      responses:
        '201':
          description: Part created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Part'
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden - ADMIN only }

  /parts/{id}:
    get:
      tags: [Parts]
      summary: Get part details by ID
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200':
          description: Part details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Part'
        '404':
          description: Part not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    put:
      tags: [Parts]
      summary: Update part (ADMIN only)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PartCreate'
      responses:
        '200':
          description: Part updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Part'
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden - ADMIN only }
        '404': { description: Part not found }
    delete:
      tags: [Parts]
      summary: Delete part (ADMIN only)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200':
          description: Part deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Part'
        '401': { description: Unauthorized }
        '403': { description: Forbidden - ADMIN only }
        '404': { description: Part not found }

  # ---------- Part Images ----------
  /parts/{partId}/images:
    post:
      tags: [Parts]
      summary: Upload one or more images for a part (ADMIN only)
      description: >
        Upload part images. The first uploaded image becomes the main image if no main image exists.
        Maximum 10 images per request. Supported formats: JPEG, PNG, GIF, WebP. Max size: 5MB per file.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: partId
          required: true
          schema: { type: integer }
          description: ID of the part
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                images:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: Image files to upload (max 10)
      responses:
        '201':
          description: Images uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "3 image(s) uploaded successfully" }
                  images:
                    type: array
                    items:
                      $ref: '#/components/schemas/PartImage'
        '400': { description: Bad request - no files or invalid file type }
        '401': { description: Unauthorized }
        '403': { description: Forbidden - ADMIN only }
        '404': { description: Part not found }
    
    get:
      tags: [Parts]
      summary: List all images for a part
      description: Returns all images for a specific part, sorted with main image first
      parameters:
        - in: path
          name: partId
          required: true
          schema: { type: integer }
          description: ID of the part
      responses:
        '200':
          description: List of part images
          content:
            application/json:
              schema:
                type: object
                properties:
                  images:
                    type: array
                    items:
                      $ref: '#/components/schemas/PartImage'
        '400': { description: Bad request }
        '404': { description: Part not found }

  /parts/{partId}/images/{imageId}/main:
    put:
      tags: [Parts]
      summary: Set an image as the main image for a part (ADMIN only)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: partId
          required: true
          schema: { type: integer }
        - in: path
          name: imageId
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Main image updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  image: { $ref: '#/components/schemas/PartImage' }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden - ADMIN only }
        '404': { description: Part or image not found }

  /parts/{partId}/images/reorder:
    put:
      tags: [Parts]
      summary: Reorder part images (ADMIN only)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: partId
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [imageIds]
              properties:
                imageIds:
                  type: array
                  items: { type: integer }
      responses:
        '200':
          description: Images reordered
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  images: { type: array, items: { $ref: '#/components/schemas/PartImage' } }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden - ADMIN only }
        '404': { description: Part not found }

  /parts/{partId}/images/{imageId}:
    delete:
      tags: [Parts]
      summary: Delete a part image (ADMIN only)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: partId
          required: true
          schema: { type: integer }
        - in: path
          name: imageId
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Image deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  image: { $ref: '#/components/schemas/PartImage' }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden - ADMIN only }
        '404': { description: Part or image not found }

  # ---------- Contracts ----------
  /contracts:
    get:
      tags: [Contracts]
      summary: List all contracts (ADMIN)
      description: Filter contracts by state, userId, or carId. Results ordered by startDate descending.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: state
          required: false
          schema:
            $ref: '#/components/schemas/ContractState'
          description: Filter by contract state
        - in: query
          name: userId
          required: false
          schema:
            type: integer
          description: Filter by user ID
        - in: query
          name: carId
          required: false
          schema:
            type: integer
          description: Filter by car ID
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/Contract' } } } }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
    post:
      tags: [Contracts]
      summary: Create a contract (USER/ADMIN)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ContractCreate' }
            example:
              carId: 1
              startDate: 2025-09-20T00:00:00Z
              endDate: 2025-09-22T00:00:00Z
              mileageStartKm: 60000
              fuelLevelStartPct: 80
              notes: "Airport pickup"
      responses:
        '201': { description: Created, content: { application/json: { schema: { $ref: '#/components/schemas/Contract' } } } }
        '400': { description: Bad request }
        '401': { description: Unauthorized }

  /contracts/my:
    get:
      tags: [Contracts]
      summary: Get current user's contracts
      description: Returns all contracts for the authenticated user with car details and main image
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: User's contracts
          content:
            application/json:
              schema:
                type: array
                items:
                  allOf:
                    - $ref: '#/components/schemas/Contract'
                    - type: object
                      properties:
                        car:
                          type: object
                          properties:
                            id: { type: integer }
                            make: { type: string }
                            model: { type: string }
                            year: { type: integer }
                            numberPlate: { type: string }
                            images:
                              type: array
                              items:
                                $ref: '#/components/schemas/CarImage'
        '401': { description: Unauthorized }

  /contracts/{id}:
    get:
      tags: [Contracts]
      summary: Get contract by ID (owner or ADMIN)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Contract' } } } }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
    put:
      tags: [Contracts]
      summary: Update contract (owner or ADMIN). Change start/end dates, carId, state, end mileage/fuel, notes.
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ContractUpdate' }
            example:
              carId: 2
              startDate: 2025-10-20T00:00:00Z
              endDate: 2025-10-23T00:00:00Z
              state: ACTIVE
              mileageEndKm: 60350
              fuelLevelEndPct: 50
              notes: "Extended trip"
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Contract' } } } }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
    delete:
      tags: [Contracts]
      summary: Delete contract (owner or ADMIN)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        '200': { description: Deleted contract, content: { application/json: { schema: { $ref: '#/components/schemas/Contract' } } } }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }

  /contracts/{id}/complete:
    post:
      tags: [Contracts]
      summary: Complete a contract (owner or ADMIN). Records end mileage/fuel, computes extra fees, sets state to COMPLETED.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ContractComplete' }
            example:
              mileageEndKm: 60350
              fuelLevelEndPct: 50
              damageFee: 0
              notes: "Returned on time"
      responses:
        '200':
          description: Completed contract
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Contract' }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
        '404': { description: Not found }
        '409': { description: Invalid state transition }

  /contracts/{id}/activate:
    post:
      tags: [Contracts]
      summary: Activate a contract (ADMIN only). Transitions from DRAFT to ACTIVE.
      description: >
        Changes contract state from DRAFT to ACTIVE and sets the associated car's state to LEASED.
        Only contracts in DRAFT state can be activated.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: Contract ID
      responses:
        '200':
          description: Activated contract
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Contract' }
        '400':
          description: Bad request - contract not in DRAFT state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthorized }
        '403': { description: Forbidden - requires ADMIN role }
        '404': { description: Contract not found }

  /contracts/{id}/cancel:
    post:
      tags: [Contracts]
      summary: Cancel a contract (owner or ADMIN). Transitions DRAFT or ACTIVE to CANCELLED.
      description: >
        Changes contract state to CANCELLED.
        If contract was ACTIVE, sets the associated car's state back to AVAILABLE.
        Cannot cancel contracts that are already COMPLETED or CANCELLED.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
          description: Contract ID
      responses:
        '200':
          description: Cancelled contract
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Contract' }
        '400':
          description: Bad request - contract already completed or cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthorized }
        '403': { description: Forbidden - must be owner or ADMIN }
        '404': { description: Contract not found }

  # ---------- Car Images ----------
  /cars/{carId}/images:
    post:
      tags: [Cars]
      summary: Upload one or more images for a car (ADMIN only)
      description: >
        Upload car images. The first uploaded image becomes the main image if no main image exists.
        Maximum 10 images per request. Supported formats: JPEG, PNG, GIF, WebP. Max size: 5MB per file.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: carId
          required: true
          schema: { type: integer }
          description: ID of the car
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                images:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: Image files to upload (max 10)
      responses:
        '201':
          description: Images uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "3 image(s) uploaded successfully" }
                  images:
                    type: array
                    items:
                      $ref: '#/components/schemas/CarImage'
        '400':
          description: Bad request - no files or invalid file type
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
        '404':
          description: Car not found
    
    get:
      tags: [Cars]
      summary: List all images for a car
      description: Returns all images for a specific car, sorted with main image first
      parameters:
        - in: path
          name: carId
          required: true
          schema: { type: integer }
          description: ID of the car
      responses:
        '200':
          description: List of car images
          content:
            application/json:
              schema:
                type: object
                properties:
                  images:
                    type: array
                    items:
                      $ref: '#/components/schemas/CarImage'
        '400': { description: Bad request }
        '404': { description: Car not found }

  /cars/{carId}/images/{imageId}/main:
    put:
      tags: [Cars]
      summary: Set an image as the main image for a car (ADMIN only)
      description: >
        Sets the specified image as the main image for the car.
        All other images for this car will have isMain set to false.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: carId
          required: true
          schema: { type: integer }
          description: ID of the car
        - in: path
          name: imageId
          required: true
          schema: { type: integer }
          description: ID of the image to set as main
      responses:
        '200':
          description: Main image updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "Main image updated successfully" }
                  image: { $ref: '#/components/schemas/CarImage' }
        '400':
          description: Bad request - image does not belong to car
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
        '404':
          description: Car or image not found

  /cars/{carId}/images/reorder:
    put:
      tags: [Cars]
      summary: Reorder car images (ADMIN only)
      description: >
        Updates the display order of images for a car.
        Provide an array of image IDs in the desired order.
        All image IDs must belong to the specified car.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: carId
          required: true
          schema: { type: integer }
          description: ID of the car
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [imageIds]
              properties:
                imageIds:
                  type: array
                  items: { type: integer }
                  example: [3, 1, 2, 4]
                  description: Array of image IDs in desired order
              additionalProperties: false
      responses:
        '200':
          description: Images reordered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "Images reordered successfully" }
                  images:
                    type: array
                    items:
                      $ref: '#/components/schemas/CarImage'
        '400':
          description: Bad request - validation failed or images don't belong to car
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
        '404':
          description: Car not found

  /cars/{carId}/images/{imageId}:
    delete:
      tags: [Cars]
      summary: Delete a car image (ADMIN only)
      description: >
        Deletes the specified image from the car.
        If the deleted image was the main image, another image (oldest) will automatically become the main image.
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: carId
          required: true
          schema: { type: integer }
          description: ID of the car
        - in: path
          name: imageId
          required: true
          schema: { type: integer }
          description: ID of the image to delete
      responses:
        '200':
          description: Image deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "Image deleted successfully" }
                  image: { $ref: '#/components/schemas/CarImage' }
        '400':
          description: Bad request - image does not belong to car
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
        '404':
          description: Car or image not found

  # ================== Contacts ==================
  /contacts:
    get:
      tags: [Contacts]
      summary: Get contact information (Public)
      description: Returns the company contact information with operation areas. No authentication required.
      responses:
        '200':
          description: Contact information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contact'
        '404':
          description: Contact not found (frontend can show create form)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags: [Contacts]
      summary: Create contact information (ADMIN only)
      description: Creates new contact information. Only one contact record should exist.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactCreate'
            example:
              email: "contact@carlease.com"
              phone: "+370 612 34567"
              operationAreas:
                - cityId: 1
                  address: "Konstitucijos pr. 20"
                - cityId: 2
                  address: ""
      responses:
        '201':
          description: Contact created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contact'
        '400':
          description: Bad request - validation failed or contact already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

    put:
      tags: [Contacts]
      summary: Update contact information (ADMIN only)
      description: Updates existing contact information. All fields are optional.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactUpdate'
            example:
              email: "newcontact@carlease.com"
              phone: "+370 612 99999"
              operationAreas:
                - cityId: 1
                  address: "New address 123"
                - cityId: 3
                  address: "Another location"
      responses:
        '200':
          description: Contact updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Contact'
        '400':
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
        '404':
          description: Contact not found - use POST to create
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ========== PRICING ==========
  /api/pricing/calculate:
    post:
      tags: [Pricing]
      summary: Calculate dynamic price for a car rental
      description: Returns the optimized price based on demand, seasonality, duration, and other factors
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [carId, startDate, endDate, pickupCityId, dropoffCityId]
              properties:
                carId: { type: integer, example: 1 }
                startDate: { type: string, format: date, example: "2026-03-10" }
                endDate: { type: string, format: date, example: "2026-03-17" }
                pickupCityId: { type: integer, example: 1 }
                dropoffCityId: { type: integer, example: 1 }
                userId: { type: integer, description: "Optional - for loyalty pricing", example: 2 }
            example:
              carId: 1
              startDate: "2026-03-10"
              endDate: "2026-03-17"
              pickupCityId: 1
              dropoffCityId: 1
      responses:
        '200':
          description: Price calculated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  carId: { type: integer }
                  cityId: { type: integer }
                  cityName: { type: string }
                  basePrice: { type: number }
                  pricePerDay: { type: number }
                  totalPrice: { type: number }
                  duration: { type: integer }
                  startDate: { type: string, format: date-time }
                  endDate: { type: string, format: date-time }
                  breakdown: { type: object }
                  isDynamic: { type: boolean }
                  calculatedAt: { type: string, format: date-time }

  /api/pricing/preview/{carId}:
    get:
      tags: [Pricing]
      summary: Get pricing preview for a car
      parameters:
        - name: carId
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Pricing preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  carId: { type: integer }
                  basePricePerDay: { type: number }
                  minPricePerDay: { type: number }
                  maxPricePerDay: { type: number }
                  useDynamicPricing: { type: boolean }

  /api/pricing/bulk-calculate:
    post:
      tags: [Pricing]
      summary: Calculate prices for multiple cars at once
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [carIds, startDate, endDate, pickupCityId, dropoffCityId]
              properties:
                carIds: { type: array, items: { type: integer }, example: [1, 2, 3] }
                startDate: { type: string, format: date, example: "2026-06-15" }
                endDate: { type: string, format: date, example: "2026-06-22" }
                pickupCityId: { type: integer, example: 1 }
                dropoffCityId: { type: integer, example: 1 }
            example:
              carIds: [1, 2, 3]
              startDate: "2026-06-15"
              endDate: "2026-06-22"
              pickupCityId: 1
              dropoffCityId: 1
      responses:
        '200':
          description: Prices calculated
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/pricing/demand/{cityId}:
    get:
      tags: [Pricing]
      summary: Get demand metrics for a city
      parameters:
        - name: cityId
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: City demand data
          content:
            application/json:
              schema:
                type: object
                properties:
                  cityId: { type: integer }
                  totalCars: { type: integer }
                  availableCars: { type: integer }
                  activeContracts: { type: integer }
                  utilizationRate: { type: number }
                  demandScore: { type: number }

  /api/pricing/loyalty:
    get:
      tags: [Pricing]
      summary: Get customer loyalty discount tier
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Loyalty information
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId: { type: integer }
                  tier: { type: string }
                  discount: { type: number }
                  completedContracts: { type: integer }

  # ========== ADMIN PRICING ==========
  /api/admin/pricing/analytics:
    get:
      tags: [Admin - Pricing]
      summary: Get pricing analytics and revenue insights
      description: Returns both actual revenue from completed contracts and pricing algorithm performance metrics
      security:
        - bearerAuth: []
      parameters:
        - name: startDate
          in: query
          schema: { type: string, format: date }
          description: Start date for analytics period (default: 30 days ago)
        - name: endDate
          in: query
          schema: { type: string, format: date }
          description: End date for analytics period (default: now)
        - name: cityId
          in: query
          schema: { type: integer }
          description: Optional - filter by city
      responses:
        '200':
          description: Analytics data with revenue and pricing metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  revenue:
                    type: object
                    properties:
                      total: { type: number, example: 1250.50 }
                      totalContracts: { type: integer, example: 15 }
                      avgPerContract: { type: number, example: 83.37 }
                      avgPricePerDay: { type: number, example: 45.25 }
                  pricingPerformance:
                    type: object
                    properties:
                      dynamicPricingAdoption: { type: number, example: 85.5, description: "Percentage of cars with dynamic pricing enabled" }
                      totalCars: { type: integer, example: 20, description: "Total cars available for lease" }
                      dynamicPricingCars: { type: integer, example: 17, description: "Number of cars with dynamic pricing enabled" }
                      contractsWithPricing: { type: integer, example: 12, description: "Contracts with pricing data" }
                      totalContracts: { type: integer, example: 15, description: "Total contracts in period" }
                      revenueImpact: { type: number, example: 12.3, description: "Revenue change percentage vs base price" }
                      avgDemandMultiplier: { type: number, example: 1.15 }
                      avgSeasonalMultiplier: { type: number, example: 1.05 }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

  /api/admin/pricing/revenue:
    get:
      tags: [Admin - Pricing]
      summary: Get detailed revenue breakdown
      description: Focused revenue analytics showing completed, pending, and lost revenue with city/car breakdowns
      security:
        - bearerAuth: []
      parameters:
        - name: startDate
          in: query
          schema: { type: string, format: date }
          description: Start date (default: 90 days ago)
        - name: endDate
          in: query
          schema: { type: string, format: date }
          description: End date (default: now)
        - name: cityId
          in: query
          schema: { type: integer }
          description: Optional - filter by city
        - name: groupBy
          in: query
          schema: { type: string, enum: [city] }
          description: Group results by city
      responses:
        '200':
          description: Revenue breakdown
          content:
            application/json:
              schema:
                type: object
                properties:
                  summary:
                    type: object
                    properties:
                      totalRevenue: { type: number, example: 1250.50 }
                      pendingRevenue: { type: number, example: 850.00 }
                      lostRevenue: { type: number, example: 120.00 }
                      completedContracts: { type: integer, example: 15 }
                      activeContracts: { type: integer, example: 8 }
                      cancelledContracts: { type: integer, example: 2 }
                  topCars:
                    type: array
                    items:
                      type: object
                      properties:
                        car: { type: string }
                        revenue: { type: number }
                        contracts: { type: integer }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

  /api/admin/pricing/performance:
    get:
      tags: [Admin - Pricing]
      summary: Get car performance metrics
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Performance data
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    carId: { type: integer }
                    utilizationRate: { type: number }
                    avgPriceMultiplier: { type: number }
                    totalContracts: { type: integer }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

  /api/admin/pricing/cars/{id}/config:
    put:
      tags: [Admin - Pricing]
      summary: Update car pricing configuration
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                basePricePerDay: { type: number, example: 45.0 }
                minPricePerDay: { type: number, example: 30.0 }
                maxPricePerDay: { type: number, example: 85.0 }
                useDynamicPricing: { type: boolean, example: true }
                dailyOperatingCost: { type: number, example: 5.0 }
                maintenanceCostPerKm: { type: number, example: 0.15 }
            example:
              basePricePerDay: 45.0
              minPricePerDay: 30.0
              maxPricePerDay: 85.0
              useDynamicPricing: true
              dailyOperatingCost: 5.0
              maintenanceCostPerKm: 0.15
      responses:
        '200':
          description: Configuration updated
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

  /api/admin/pricing/rules:
    get:
      tags: [Admin - Pricing]
      summary: List all pricing rules
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Pricing rules list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
    post:
      tags: [Admin - Pricing]
      summary: Create a new pricing rule
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, multiplier]
              properties:
                name: { type: string, example: "Weekend Special" }
                carId: { type: integer, description: "Optional - apply to specific car", example: 1 }
                cityId: { type: integer, description: "Optional - apply to specific city", example: 1 }
                multiplier: { type: number, example: 0.9 }
                startDate: { type: string, format: date, example: "2026-03-01" }
                endDate: { type: string, format: date, example: "2026-03-31" }
                priority: { type: integer, default: 0, example: 5 }
                isActive: { type: boolean, default: true, example: true }
            example:
              name: "March Promotion"
              multiplier: 0.85
              startDate: "2026-03-01"
              endDate: "2026-03-31"
              priority: 5
              isActive: true
      responses:
        '201':
          description: Rule created
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

  /api/admin/pricing/rules/{id}:
    put:
      tags: [Admin - Pricing]
      summary: Update a pricing rule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Rule updated
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
    delete:
      tags: [Admin - Pricing]
      summary: Delete a pricing rule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Rule deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

  /api/admin/pricing/seasonal-factors:
    get:
      tags: [Admin - Pricing]
      summary: List all seasonal pricing factors
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Seasonal factors list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
    post:
      tags: [Admin - Pricing]
      summary: Create a seasonal pricing factor
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, startDate, endDate, multiplier]
              properties:
                name: { type: string, example: "Summer Peak Season" }
                startDate: { type: string, format: date, example: "2026-06-01" }
                endDate: { type: string, format: date, example: "2026-08-31" }
                multiplier: { type: number, example: 1.3 }
                isActive: { type: boolean, default: true, example: true }
            example:
              name: "Summer Peak Season"
              startDate: "2026-06-01"
              endDate: "2026-08-31"
              multiplier: 1.3
              isActive: true
      responses:
        '201':
          description: Seasonal factor created
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only

  /api/admin/pricing/refresh:
    post:
      tags: [Admin - Pricing]
      summary: Manually trigger pricing data refresh
      description: Recalculates demand metrics and utilization data for all cities and cars
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Refresh completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  citiesUpdated: { type: integer }
                  carsUpdated: { type: integer }
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - ADMIN only
